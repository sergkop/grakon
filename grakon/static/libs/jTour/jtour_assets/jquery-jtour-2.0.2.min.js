/*
 * jTour Multipage Website Tour 2.0.2
 * http://benmartinstudios.com/
 *
 * Copyright 2012, Ben Martin
 * Must not be used without permission
 * Contact ben.martin@benmartinstudios.com for more details
 *
*/

(function(a){function j(a,b,c,d,e){b.isTrans=false;if(typeof e!=="boolean"){e=true}d.tourBox.fadeTo(a.fadeTime,1);if(typeof c.onStart==="function"){c.onStart.call(b.inst,c.elem,b.tourBox.tourBox)}if(!b.isPaused){g.resumeTimer(a,b,c,d)}if(b.pauseOnHover){d.tourBox.hover(function(a){b.inst.pause()},function(a){b.inst.resume()})}}function c(a,b,c){return a>=b&&a<=c}function b(a,b,c){return Math.min(Math.max(b,a),c)}var d=a("body"),e=a(window),f=a("html"),g={},h={};g.destroyTour=function(b,c,d){c.isDestroyed=true;c.isTrans=false;c.isPaused=false;c.tourBox.timer.stop(true,false);c.overlay.add(c.holder).fadeOut(b.fadeTime,function(){a(this).remove()});g.unSpotlight();c.tourBox.tourBox.fadeOut(b.fadeTime,function(){a(this).remove();if(typeof d==="function"){d.call(c.inst)}b.onTourClose.call(c.inst)});window.location.hash="_"};g.unSpotlight=function(){a(".jt-spotlit").removeClass("jt-spotlit")};g.loadPage=function(a,b,c,d){var e=a.pages[c].url;window.location=e+"#jTour/"+a.tourId+"/"+c+"/"+(typeof item!=="undefined"?item:"0")};g.parseHashTag=function(a,b){var c=window.location.hash;if(c.substring(1,6)!=="jTour"){return false}return c.substring(7).split("/")};g.parsePosition=function(a){return{h:a.indexOf("l")>=0?-1:a.indexOf("r")>=0?1:0,v:a.indexOf("t")>=0?-1:a.indexOf("b")>=0?1:0}};g.isInViewport=function(a){a.fadeTo(0,.01);var b=e.scrollLeft(),d=b+e.width(),f=e.scrollTop(),g=f+e.height(),h=a.offset(),i={x:false,y:false};if(c(h.left,b,d)&&c(h.left+a.width(),b,d)){i.x=true}if(c(h.top,f,g)&&c(h.top+a.height(),f,g)){i.y=true}return i};g.loadItem=function(a,c,h,i){var k=c.tourBox;if(typeof i!=="boolean"){i=true}var l=a.pages[c.currentPage].items[h];c.page=l;l.elemO=l.elem.offset();if(typeof l.title!=="undefined"){k.heading.text(l.title).show()}else{k.heading.hide()}k.message.html(l.msg);k.timer.width("0%");var m=.5*(l.elemPos.h+1)*l.elem.width()-.5*(l.boxPos.h+1)*k.tourBox.width(),n=.5*(l.elemPos.v+1)*l.elem.height()-.5*(l.boxPos.v+1)*k.tourBox.height(),o=l.elemO.left+m+l.offsetLeft,p=l.elemO.top+n+l.offsetTop;if(a.keepOnPage){o=b(o,0,Math.max(d.width(),e.width())-k.tourBox.width());p=b(p,0,Math.max(d.height(),e.height())-k.tourBox.height())}k.tourBox.css("top",p).css("left",o);var q=g.isInViewport(k.tourBox);if(q.x&&q.y){j(a,c,l,k,i)}else{var r={scrollLeft:d.scrollLeft(),scrollTop:d.scrollTop()};if(!q.y){r.scrollTop=p+l.scrollTop}if(!q.x){r.scrollLeft=o+l.scrollLeft}d.add(f).animate(r,{duration:a.scrollTime,complete:function(){j(a,c,l,k,i)}})}};g.transition=function(a,b,d,e){if(b.isTrans){return false}b.isTrans=true;b.tourBox.timer.stop(true,true);g.unSpotlight();var f=e;if(e==="+"||e==="next"){f=b.currentItem+1}else if(e==="-"||e==="previous"){f=b.currentItem-1}b.currentItem=f;b.tourBox.tourBox.fadeOut(a.fadeTim,function(){if(c(f,0,a.pages[b.currentPage].items.length-1)){g.loadItem(a,b,f)}else{if(f===-1){if(b.currentPage===0){g.destroyTour(a,b)}else{g.loadPage(a,b,b.currentPage-1)}}else{if(b.currentPage===a.pages.length-1){g.destroyTour(a,b)}else{g.loadPage(a,b,b.currentPage+1)}}}})};g.resumeTimer=function(b,c,d,e){if(c.isDestroyed){return}clearTimeout(c.delay);c.tourBox.controls.find("a.play-pause").removeClass("paused");if(typeof d.steps==="object"){var f={};a.each(d.steps,function(a,b){f[a]="step"})}var h=parseFloat(e.timer[0].style.width,10)/100;e.timer.width(h*100+1+"%");e.timer.animate({width:"100%"},{duration:d.delay*(1-h),complete:function(){e.tourBox.unbind("mouseenter mouseleave");g.unSpotlight();if(typeof d.onComplete==="function"){d.onComplete.call(c.inst,d.elem,c.tourBox.tourBox)}g.transition(b,c,d,"+")},step:function(b,e){if(typeof d.onStep==="function"){d.onStep.call(c.inst,d.elem,c.tourBox.tourBox,b)}b=Math.round(b);var g=false;if(typeof f!=="undefined"){a.each(f,function(a,c){if(parseInt(c,10)>=b){g=true}return false});if(typeof f[b]!=="undefined"||g){d.steps[b].call(c.inst,d.elem,c.tourBox.tourBox);delete f[b]}g=false}}})};d.delegate("a.jtour","click",function(b){var c=a(this).attr("href");if(c.substr(0,1)==="#"){window.location.hash=c;var d=g.parseHashTag(c)[0];if(typeof h[d]!=="undefined"){h[d].init();b.preventDefault()}}});var k=function(b,c){var e=function(){k.isDestroyed=false;var b=g.parseHashTag(j,k);k.currentPage=parseInt(typeof b[1]!=="undefined"?b[1]:0,10);k.currentItem=parseInt(typeof b[2]!=="undefined"?b[2]:0,10);if(!b||b[0]!==j.tourId){return false}g.loadPage(j,k,k.currentPage,k.currentItem);d.append('<div class="jtour overlay"/>');k.overlay=d.children(".jtour.overlay");k.holder=a('<div class="jtour holder"/>');if(k.isMaiden){a.each(j.pages[k.currentPage].items,function(b,c){var d=a.extend({},l,c);elem=a(c.sel).first(),btn=a('<a class="jtour-btn" data-itemNum="'+c.num+' data-num="'+b+">"+c.num+"</a>"),elemO=elem.offset();d.elem=elem;d.elemPos=g.parsePosition(d.elemPos);d.boxPos=g.parsePosition(d.boxPos);j.pages[k.currentPage].items[b]=d})}var c=a('<div class="jtour box"/>'),e=a('<div class="jtour main"/>'),f=a('<div class="jtour controls"/>');cntrls_ar=["previous","play-pause","stop","next"];cntrls_ke=["Previous Item: Up/Left Arrow","Play/Pause: Spacebar","Stop: Esc","Next Item: Right/Down Arrow"];e.append('<h1 class="jtour heading">jTour Demo</h1>').append('<div class="message"><p>Lorem ipsum.</p></div>').append('<div class="jtour timer"/>');for(i=0;i<4;i++){f.append('<a class="jtour-ctrl '+cntrls_ar[i]+'" href="#'+cntrls_ar[i]+'" title="'+cntrls_ke[i]+'"/>')}if(!j.autoPlay){k.isPaused=true;f.find(".play-pause").addClass("paused")}e.append(f);c.append(e);c.fadeTo(0,0);k.holder.append(c);k.tourBox={tourBox:c,heading:c.find("h1"),message:c.find(".message"),controls:c.find(".controls"),timer:c.find(".timer")};d.append(k.holder);if(j.overlayCancel){k.holder.click(function(b){if(a(b.target).hasClass("holder")){g.destroyTour(j,k)}})}if(k.isMaiden){c.hover(function(a){k.isHovered=true},function(a){k.isHovered=false});var h=function(b){if(!k.isDestroyed){b.preventDefault();var c=a(this),d=b.type==="click"?c.attr("href"):b.keyCode+"";d=b.type==="click"?c.attr("href"):b.keyCode+"";if(d.match(/#previous|37|38/)){g.transition(j,k,k.page,"-");b.preventDefault()}else if(d.match(/#next|39|40/)){g.transition(j,k,k.page,"+");b.preventDefault()}else if(d.match(/#play-pause|32/)){k.isHovered=true;if(!k.isTrans){if(k.isPaused){n()}else{m()}}b.preventDefault()}else if(d.match(/#stop|27/)){g.destroyTour(j,k);b.preventDefault()}else{return true}}};d.delegate("a.jtour-ctrl","click",h);d.keydown(h)}j.onTourOpen.call(k.inst);g.loadItem(j,k,k.currentItem,j.autoPlay);k.isMaiden=false};var f=function(b){var c=j.pages[k.currentPage].items[k.currentItem];if(typeof b==="undefined"){b={}}if(b.unSpotlightAll){g.unSpotlight()}if(typeof b.element==="undefined"){b.element=c.elem}else{b.element=a(b.element)}b.element.addClass("jt-spotlit")};this.spotlight=f;this.unSpotlight=g.unSpotlight;this.init=e;var j=a.extend({tourId:"tour",autoPlay:true,fadeTime:200,scrollTime:600,overlayCancel:true,pauseOnHover:false,keepOnPage:true,pages:[],onTourOpen:function(){},onTourClose:function(){}},b||{});var k={overlay:"",currentPage:0,currentItem:0,timer:"",isPaused:false,isDestroyed:true,isMaiden:true,isTrans:false,isHovered:false,delay:""};var l=a.extend({elemPos:"bl",boxPos:"tl",offsetTop:0,offsetLeft:0,scrollTop:0,scrollLeft:0,delay:5e3},c||{});k.inst=this;h[j.tourId]=this;var m=function(a){if(k.isPaused||k.isTrans){return false}k.tourBox.controls.find("a.play-pause").addClass("paused");k.isPaused=true;k.tourBox.timer.stop(true);if(typeof a!=="undefined"){k.delay=setTimeout(n,a)}};var n=function(){if(!k.isPaused||k.isTrans){return false}k.tourBox.controls.find("a.play-pause").removeClass("paused");k.isPaused=false;g.resumeTimer(j,k,k.page,k.tourBox)};var o=function(){g.destroyTour(j,k)};this.pause=m;this.resume=n;this.exit=o;if(j.pages.length>0){e()}};a.jTour=a.fn.jTour=function(a,b){var c=new k(a,b);return c}})(jQuery)